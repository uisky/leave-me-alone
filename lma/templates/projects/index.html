{% extends 'base.html' %}

{% block head %}
<style type="text/css">
    #folders .dropme a { border-color: #000; border-style: dashed; }

    ul.project-list { list-style: note; margin: 20px 0; padding: 0; text-align: center; }
    ul.project-list li {
        display: inline-block; margin: 0 20px 20px 0; padding: 20px 7px 20px 40px;
        background-color: #ddeef0; border-radius: 20px;
    }
    ul.project-list li.my {
        box-shadow: inset 0px 0px 0px 6px #ccdde0;
    }
    ul.project-list li a { font-size: 20px; }
    ul.project-list li .action-menu {
        visibility: hidden;
        font-size: inherit; margin-left: 10px; padding: 6px 5px 6px 8px; cursor: pointer;
    }
    ul.project-list li:hover .action-menu { visibility: visible; }
    ul.project-list .dragging { opacity: .4; }
</style>
{% endblock %}

{% block content %}
<h1 class="text-center">Мои проекты</h1>


<ul class="nav nav-tabs" id="folders">
    <li {% if not folder %} class="active" {% endif %} data-id="0">
        <a href="{{ url_for('.index') }}">
            <i class="fa fa-star" title="Проекты из этой папки показываются в меню"></i>
            Основные
        </a>
    </li>
    {% for f in folders %}
        <li {% if folder and folder.id == f.id %} class="active" {% endif %} data-id="{{ f.id }}">
            <a href="{{ url_for('.index', folder_id=f.id) }}">
                {% if f.in_menu %}<i class="fa fa-star" title="Проекты из этой папки показываются в меню"></i>{% endif %}
                {{ f.name }}
            </a>
        </li>
    {% endfor %}
    <li class="pull-right"><a href="#modal-new" data-toggle="modal" title="Создать папку"><i class="fa fa-plus"></i></a></li>
    {% if folder %}
        <li class="pull-right"><a href="#modal-edit" data-toggle="modal" title="Свойства папки"><i class="fa fa-cog"></i></a></li>
    {% endif %}
</ul>

{% if not projects %}
    <div class="alert alert-box alert-info" style="margin: 20px 0;">
        Эта папка проектов пуста.
    </div>
{% else %}
    <ul class="project-list" id="projects">
    {% for project in projects %}
        <li {%- if project.user_id == current_user.id %} class="my" {%- endif %} draggable="true" data-id="{{ project.id }}">
            <a href="{{ project.url_for() }}">{{ project.name }}</a>
            <a href="#" class="action-menu" title="Вы можете перетащить проект в другую папку">
                <i class="fa fa-arrows"></i>
            </a>
        </li>
    {% endfor %}
    </ul>
{% endif %}



<div class="container">
<form method="post" action="{{ url_for('.project_add') }}">
    {{ form.csrf_token }}
    <div class="row">
        <div class="col-sm-10">
            <input type="text" name="name" value="{{ request.form.get('name', '') }}" class="form-control" placeholder="Название">
        </div>
        <div class="col-sm-2">
            <button type="submit" class="btn btn-success">
                <span class="fa fa-bolt"></span>
                Создать проект
            </button>
        </div>
    </div>
    <div class="row" style="margin-top: 10px;">
        <div class="col-sm-10 text-center">
            <label><input type="radio" name="type" value="list" checked> Список</label>
            <label><input type="radio" name="type" value="tree"> Дерево</label>
        </div>
    </div>
</form>
</div>
{% endblock %}


{% block tail %}
<form method="post" action="{{ url_for('.folder_edit') }}">
    <div class="modal" id="modal-new" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Создать папку</h4>
    </div>
    <div class="modal-body">
        <div class="form-group">
            <label>Название:</label>
            <input type="text" name="name" class="form-control">
        </div>

        <div class="form-group">
            <label>
                <input type="checkbox" name="in_menu" checked>
                Показывать проекты из этой папки в меню
            </label>
        </div>
    </div>
    <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Создать</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">Отмена</button>
    </div>
    </div></div></div>
</form>

{% if folder %}
<form method="post" action="{{ url_for('.folder_edit', folder_id=folder.id) }}">
    <div class="modal" id="modal-edit" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Свойства папки</h4>
    </div>
    <div class="modal-body">
        <div class="form-group">
            <label>Название:</label>
            {{ form_folder_edit.name(class='form-control') }}
        </div>

        <div class="form-group">
            <label>
                {{ form_folder_edit.in_menu() }}
                Показывать проекты из этой папки в меню
            </label>
        </div>
    </div>
    <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Сохранить</button>
        <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#modal-delete">Удалить</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">Отмена</button>
    </div>
    </div></div></div>
</form>

<form method="post" action="{{ url_for('.folder_delete', folder_id=folder.id) }}">
    <div class="modal" id="modal-delete" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Удалить папку?</h4>
    </div>
    <div class="modal-body">
        <p>
            Серьёзно? Все проекты перенесутся в папку "Основные".
        </p>
    </div>
    <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Да</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">Нет</button>
    </div>
    </div></div></div>
</form>
{% endif %}

<script type="text/javascript">
(function() {
    var $projects = $('#projects'), $folders = $('#folders'), $dragEl;

    $('.modal').on('shown.bs.modal', function() {
        $(this).find('input:eq(0)').focus();
    });

    $projects.find('li')
        .on('dragstart', function(e) {
            $(this).addClass('dragging');
            $dragEl = $(this);
        })
        .on('dragend', function(e) {
            $(this).removeClass('dragging');
        });

    $folders.find('li')
        .on('dragenter', function(e) { $(this).addClass('dropme'); })
        .on('dragleave', function(e) { $(this).removeClass('dropme'); })
        .on('dragover', function(e) { e.preventDefault(); })
        .on('drop', function(e) {
            $(this).removeClass('dropme');
            $.ajax({
                type: 'post',
                url: '{{ url_for('.folder_set') }}',
                data: {project_id: $dragEl.data('id'), folder_id: $(this).data('id')},
                dataType: "json",
                success: function(data) {
                    if(data.error) return alert(data.error);
                    $projects.find('[data-id=' + data.project_id + ']').hide();
                }
            });
        });
})();
</script>
{% endblock %}