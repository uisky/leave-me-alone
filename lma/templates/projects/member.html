{% extends 'project.html' %}
{% set container_class = 'container' %}
{% if member.user_id == current_user.id %}
    {% set menu_current = 'my' %}
{% else %}
    {% set menu_current = 'members' %}
{% endif %}


{% block head %}
<style type="text/css">
    .btn.active { font-weight: bold; border: 2px solid black;}
</style>
{% endblock %}


{% block content %}
<h1>Участие {{ member.user.name }} в {{ project.name }}</h1>

<form id="form-filter" method="get" class="form-inline" style="margin-bottom: 20px;">
    <a href="{{ url_for('.about', project_id=project.id) }}" class="btn btn-default btn-sm">
        <span class="fa fa-chevron-circle-left"></span>
        Назад
    </a>
    <div class="form-group">
        {{ filters.status() }}
        {% for st in g.Task.STATUSES %}
            <button type="button"
                    class="btn {{ st|status_class }} btn-sm btn-filter-status {% if st in statuses %}active{% endif %}"
                    data-status="{{ st }}">
                {{ st|status_rus }}
            </button>
        {% endfor %}
    </div>

    {% if project.has_sprints %}
    <div class="form-group">
        {{ filters.sprint(class='form-control') }}
    </div>
    {% endif %}

    <button type="submit" class="btn btn-primary pull-right">
        Показать
    </button>
</form>

{% if not tasks.total %}
    <div class="alert alert-info">
        Задач не обнаружено.
    </div>
{% else %}
<table class="table table-bordered">
    <thead>
    <tr>
        <th>Поставлено</th>
        <th>Статус</th>
        {% if project.has_sprints %}<th>Веха</th>{% endif %}
        <th>Задача</th>
        <th>Дедлайн</th>
    </tr>
    {% for task in tasks.items %}
    <tr>
        <td>{{ task.created.strftime('%d.%m.%Y %H:%M') }}</td>
        <td>{{ task.status|status_label }}</td>
        {% if project.has_sprints %}
            <td>
                {% if task.sprint_id %}
                    {{ task.sprint.name }}
                {% else %}
                    —
                {% endif %}
            </td>
        {% endif %}
        <td>
            {{ task.character|character_icon|safe }}
            <a href="{{ url_for('.tasks', project_id=project.id, task=task.id, sprint=task.sprint_id or '') }}">{{ task.path }}</a>
            {{ task.importance|importance_icon|safe }}
        </td>
        <td {% if task.deadline and task.status not in ('complete', 'canceled') and task.deadline < g.now %} style="color:#f00" {% endif %}>
            {% if task.deadline %}
                {{ task.deadline.strftime('%d.%m.%Y') }}
            {% endif %}
        </td>
    </tr>
    {% endfor %}
    </thead>
</table>

    {{ render_pagination(tasks, '.member',
                         project_id=project.id, member_id=member.user_id,
                         status=filters.status.data, sprint=filters.sprint.data) }}
{% endif %}
{% endblock %}


{% block tail %}
<script type="text/javascript">
(function() {
    $('#form-filter .btn-filter-status').click(function(e) {
        var $this = $(this);
        if($this.hasClass('active')) {
            $this.removeClass('active');
        } else {
            $this.addClass('active');
        }

        var v = [];
        $('#form-filter .btn-filter-status.active').each(function() {
            v.push($(this).data('status'))
        });
        $('#form-filter input[name=status]').val(v.join(','));

        $this.blur();
    });
})();
</script>
{% endblock %}