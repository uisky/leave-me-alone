{% extends 'base.html' %}

{%- macro member_link(project, user) -%}
    <a href="{{ url_for('.member', project_id=project.id, member_id=user.id) }}" class="user">{{ user.name }}</a>
{%- endmacro -%}

{% set menu = (
    {'id': 'tasks', 'url': url_for('.tasks', project_id=project.id), 'title': 'Задачи'},
    {'id': 'my', 'url': url_for('.member', project_id=project.id, member_id=current_user.id), 'title': 'Мои задачи' + tasks_stat(project, current_user)|status_counters},
    {'id': 'about', 'url': url_for('.about', project_id=project.id), 'title': 'О проекте'},
    {'id': 'history', 'url': url_for('.history', project_id=project.id), 'title': 'История'},
)
%}

{% block logo %}
<div class="navbar-header">
    <a class="navbar-brand dropdown-toggle" href="/" data-toggle="dropdown">
        LMA: {{ project.name }}
        <span class="caret"></span>
    </a>

    {% macro menu_project_li(prj, project) %}
        <li {%- if project and prj.id == project.id %} class="active" {%- endif -%}>
            <a href="{{ url_for('projects.tasks', project_id=prj.id) }}">
            {{- prj.name -}}
            </a>
        </li>
    {% endmacro %}

    {% with pmenu = projects_menu(current_user) %}
        <ul class="dropdown-menu menu-projects">
            {% if pmenu|length == 1 %}
                {% for prj in projects_menu(current_user).popitem()[1] %}
                    {{ menu_project_li(prj, project) }}
                {% endfor %}
            {% else %}
                {%- for folder, projects in pmenu.items() %}
                    <li class="folder">{{ folder.name|default('Основные') }}</li>
                    {% for prj in projects %}
                        {{ menu_project_li(prj, project) }}
                    {% endfor %}
                {%- endfor -%}
            {% endif %}
            <li role="separator" class="divider"></li>
            <li><a href="/projects" title="Центр Управления Проектами"><i class="fa fa-rocket"></i> ЦУП</a></li>
        </ul>
    {% endwith %}
</div>
{% endblock %}

{% block menu_main %}
<ul class="nav navbar-nav">
{%- for item in menu %}
    <li {%- if menu_current == item.id %} class="active" {%- endif -%}><a href="{{ item.url }}">{{ item.title }}</a></li>
{%- endfor -%}
</ul>
{% endblock %}